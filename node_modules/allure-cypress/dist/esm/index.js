var u=function(e){return e.FAILED="failed",e.BROKEN="broken",e.PASSED="passed",e.SKIPPED="skipped",e}({}),Oe=[u.FAILED,u.BROKEN,u.PASSED,u.SKIPPED],Ne=function(e){return e.SCHEDULED="scheduled",e.RUNNING="running",e.FINISHED="finished",e.PENDING="pending",e.INTERRUPTED="interrupted",e}({}),l=function(e){return e.ALLURE_ID="ALLURE_ID",e.AS_ID="ALLURE_ID",e.SUITE="suite",e.PARENT_SUITE="parentSuite",e.SUB_SUITE="subSuite",e.EPIC="epic",e.FEATURE="feature",e.STORY="story",e.SEVERITY="severity",e.TAG="tag",e.OWNER="owner",e.LEAD="lead",e.HOST="host",e.THREAD="thread",e.TEST_METHOD="testMethod",e.TEST_CLASS="testClass",e.PACKAGE="package",e.FRAMEWORK="framework",e.LANGUAGE="language",e.LAYER="layer",e}({}),Le=function(e){return e.BLOCKER="blocker",e.CRITICAL="critical",e.NORMAL="normal",e.MINOR="minor",e.TRIVIAL="trivial",e}({}),D=function(e){return e.TEXT="text/plain",e.XML="application/xml",e.HTML="text/html",e.CSV="text/csv",e.TSV="text/tab-separated-values",e.CSS="text/css",e.URI="text/uri-list",e.SVG="image/svg+xml",e.PNG="image/png",e.JSON="application/json",e.ZIP="application/zip",e.WEBM="video/webm",e.JPEG="image/jpeg",e.MP4="video/mp4",e.IMAGEDIFF="application/vnd.allure.image.diff",e}({}),R=function(e){return e.DEFAULT="link",e.ISSUE="issue",e.TMS="tms",e}({});function P(){P=function(a,o){return new s(a,void 0,o)};var e=RegExp.prototype,t=new WeakMap;function s(n,a,o){var i=RegExp(n,a);return t.set(i,o||t.get(n)),k(i,s.prototype)}function r(n,a){var o=t.get(a);return Object.keys(o).reduce(function(i,p){var g=o[p];if(typeof g=="number")i[p]=n[g];else{for(var h=0;n[g[h]]===void 0&&h+1<g.length;)h++;i[p]=n[g[h]]}return i},Object.create(null))}return Ue(s,RegExp),s.prototype.exec=function(n){var a=e.exec.call(this,n);if(a){a.groups=r(a,this);var o=a.indices;o&&(o.groups=r(o,this))}return a},s.prototype[Symbol.replace]=function(n,a){if(typeof a=="string"){var o=t.get(this);return e[Symbol.replace].call(this,n,a.replace(/\$<([^>]+)>/g,function(p,g){var h=o[g];return"$"+(Array.isArray(h)?h.join("$"):h)}))}if(typeof a=="function"){var i=this;return e[Symbol.replace].call(this,n,function(){var p=arguments;return typeof p[p.length-1]!="object"&&(p=[].slice.call(p)).push(r(p,i)),a.apply(this,p)})}return e[Symbol.replace].call(this,n,a)},P.apply(this,arguments)}function Ue(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&k(e,t)}function k(e,t){return k=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(s,r){return s.__proto__=r,s},k(e,t)}var S=e=>{switch(!0){case/assert/gi.test(e.constructor.name):case/expectation/gi.test(e.constructor.name):case/assert/gi.test(e.name):case/assert/gi.test(e.message):case(e.stack&&/@vitest\/expect/gi.test(e.stack)):return u.FAILED;default:return u.BROKEN}},je=function(){var{onlyFirst:t=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},s=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))"].join("|");return new RegExp(s,t?void 0:"g")},I=e=>{var t=je();return e.replace(t,"")},f=e=>{var{message:t,stack:s}=e;return{message:t?I(t):void 0,trace:s?I(s):void 0}},ee=P(/(?:^|\s)@?allure\.id[:=]([^\s]+)/,{id:1}),Ge=new RegExp(ee,"g"),te=P(/(?:^|\s)@?allure\.label\.([^:=\s]+)[:=]([^\s]+)/,{name:1,value:2}),Be=new RegExp(te,"g");var H=e=>{var t=[];e.split(" ").forEach(r=>{var n,a=(n=r.match(ee))===null||n===void 0||(n=n.groups)===null||n===void 0?void 0:n.id;a&&t.push({name:l.ALLURE_ID,value:a});var o=r.match(te),{name:i,value:p}=o?.groups||{};i&&p&&t?.push({name:i,value:p})});var s=e.replace(Be,"").replace(Ge,"").trim();return{labels:t,cleanTitle:s}};var Ve=e=>e.reduce((t,s)=>{if(s.type!=="step_start"&&s.type!=="step_stop")return t;if(s.type==="step_start")return t.push([s]),t;var r=t.findLastIndex(n=>n.length===1);return r===-1||t[r].push(s),t},[]),F=e=>{var t=Ve(e);return t.filter(s=>s.length===1)},x=e=>!!e&&(typeof e=="object"||typeof e=="function")&&typeof e.then=="function";var E="__allure_report_system_hook__",_="__allure_report_step_command__";function se(e,t,s,r,n,a,o){try{var i=e[a](o),p=i.value}catch(g){return void s(g)}i.done?t(p):Promise.resolve(p).then(r,n)}function m(e){return function(){var t=this,s=arguments;return new Promise(function(r,n){var a=e.apply(t,s);function o(p){se(a,r,n,o,i,"next",p)}function i(p){se(a,r,n,o,i,"throw",p)}o(void 0)})}}var O=class{attachment(){var t=this;return m(function*(){yield t.warning()})()}attachmentFromPath(){var t=this;return m(function*(){yield t.warning()})()}description(){var t=this;return m(function*(){yield t.warning()})()}descriptionHtml(){var t=this;return m(function*(){yield t.warning()})()}displayName(){var t=this;return m(function*(){yield t.warning()})()}historyId(){var t=this;return m(function*(){yield t.warning()})()}labels(){var t=this;return m(function*(){yield t.warning()})()}links(){var t=this;return m(function*(){yield t.warning()})()}parameter(){var t=this;return m(function*(){yield t.warning()})()}logStep(){var t=this;return m(function*(){yield t.warning()})()}step(t,s){var r=this;return m(function*(){return yield r.warning(),s()})()}stepDisplayName(){var t=this;return m(function*(){yield t.warning()})()}stepParameter(){var t=this;return m(function*(){yield t.warning()})()}testCaseId(){var t=this;return m(function*(){yield t.warning()})()}warning(){return m(function*(){console.log("no test runtime is found. Please check test framework configuration")})()}},T=new O;var re="allureTestRuntime",L=e=>{globalThis[re]=()=>e},N=()=>globalThis?.[re],U=()=>{var e=N();if(e){var t;return(t=e())!==null&&t!==void 0?t:T}return T},j=()=>{var e=N();if(e){var t;return(t=e())!==null&&t!==void 0?t:T}if("_playwrightInstance"in globalThis)try{return(0,eval)("(() => import('allure-playwright/autoconfig'))()").then(()=>{var s,r;return(s=(r=N())===null||r===void 0?void 0:r())!==null&&s!==void 0?s:T})}catch(s){return console.log("can't execute allure-playwright/autoconfig",s),T}return T};var d=function(t){for(var s=arguments.length,r=new Array(s>1?s-1:0),n=1;n<s;n++)r[n-1]=arguments[n];var a=j();return x(a)?a.then(o=>o[t](...r)):a[t](...r)},y=(e,t)=>d("labels",{name:e,value:t}),Ke=function(){for(var t=arguments.length,s=new Array(t),r=0;r<t;r++)s[r]=arguments[r];return d("labels",...s)},G=(e,t,s)=>d("links",{url:e,type:s,name:t}),ze=function(){for(var t=arguments.length,s=new Array(t),r=0;r<t;r++)s[r]=arguments[r];return d("links",...s)},We=(e,t,s)=>d("parameter",e,t,s),$e=e=>d("description",e),Ye=e=>d("descriptionHtml",e),qe=e=>d("displayName",e),Ze=e=>d("historyId",e),Je=e=>d("testCaseId",e),Xe=(e,t,s)=>{var r=typeof s=="string"?{contentType:s}:s;return d("attachment",e,t,r)},Qe=(e,t,s)=>{var r=typeof s=="string"?{contentType:s}:s;return d("attachmentFromPath",e,t,r)},et=()=>({displayName:e=>d("stepDisplayName",e),parameter:(e,t,s)=>d("stepParameter",e,t,s)}),tt=(e,t,s)=>d("logStep",e,t,s),st=(e,t)=>d("step",e,()=>t(et())),rt=(e,t)=>G(e,t,R.ISSUE),nt=(e,t)=>G(e,t,R.TMS),at=e=>y(l.ALLURE_ID,e),ot=e=>y(l.EPIC,e),it=e=>y(l.FEATURE,e),pt=e=>y(l.STORY,e),ut=e=>y(l.SUITE,e),lt=e=>y(l.PARENT_SUITE,e),ct=e=>y(l.SUB_SUITE,e),dt=e=>y(l.OWNER,e),mt=e=>y(l.SEVERITY,e),yt=e=>y(l.LAYER,e),gt=e=>y(l.TAG,e),ft=function(){for(var t=arguments.length,s=new Array(t),r=0;r<t;r++)s[r]=arguments[r];return d("labels",...s.map(n=>({name:l.TAG,value:n})))};var v=()=>{let e=Cypress.env("allure");return e||(e={initialized:!1,messages:[],testPlan:void 0,currentTest:void 0},Cypress.env("allure",e)),e},ne=()=>v().initialized,ae=()=>{v().initialized=!0},M=()=>v().messages,oe=e=>{v().messages=e},c=e=>{M().push(e)},ie=()=>v().testPlan,pe=()=>v().currentTest,ue=e=>{v().currentTest=e},le=()=>{v().currentTest=void 0};var ce=e=>Array.isArray(e)||e.buffer?btoa(String.fromCharCode.apply(null,e)):e,de=e=>{let t=[];for(let s=e.parent;s;s=s.parent)t.push(s);return t.reverse(),t};var B=e=>St(e.attributes.args)?.log===!1||e.attributes.name==="task"&&e.attributes.args[0]==="reportAllureRuntimeMessages"||e.attributes.name==="then"||e.attributes.name==="wrap"&&e.attributes.args[0]===_;var St=e=>e[e.length-1],me=(e,t)=>{let s=t.title,{cleanTitle:r,labels:n}=H(s),a=t.titlePath().slice(0,-1),o=`${e.relative}#${[...a,r].join(" ")}`;return{name:r,labels:n,fullName:o}},V=e=>({...me(Cypress.spec,e),start:e.wallClockStartedAt?.getTime()||Date.now()}),ye=e=>({duration:e.duration??0,retries:e._retries??0}),K=()=>({statusDetails:{message:"This is a pending test"}}),ge=(e,t)=>{let s=ie();if(s)for(let r of he(t)){let n=Tt(s,e,r.tests);Ct(r.tests,n)}};var fe=Symbol("The test was reported to Allure"),z=e=>{e[fe]=!0},b=e=>e[fe]===!0,he=function*(e){let t=[];for(let s=e;s;s=t.pop()){yield s;for(let r=s.suites.length-1;r>=0;r--)t.push(s.suites[r])}},Se=function*(e){for(let t of he(e))yield*t.tests},C=e=>e.title.includes(E),ve=e=>e.parent.root&&e.hookName==="after all",vt=(e,t,s)=>e.tests.some(r=>s&&r.id?.toString()===s||r.selector===t),Tt=(e,t,s)=>{let r=[];return s.forEach((n,a)=>{let{fullName:o,labels:i}=me(t,n),p=i.find(({name:g})=>g===l.ALLURE_ID)?.value;vt(e,o,p)||r.push(a)}),r},Ct=(e,t)=>{for(let s=t.length-1;s>=0;s--)e.splice(t[s],1)};var W=class{constructor(){this.#t()}labels(...t){return this.#e({type:"metadata",data:{labels:t}})}links(...t){return this.#e({type:"metadata",data:{links:t}})}parameter(t,s,r){return this.#e({type:"metadata",data:{parameters:[{name:t,value:s,...r}]}})}description(t){return this.#e({type:"metadata",data:{description:t}})}descriptionHtml(t){return this.#e({type:"metadata",data:{descriptionHtml:t}})}displayName(t){return this.#e({type:"metadata",data:{displayName:t}})}historyId(t){return this.#e({type:"metadata",data:{historyId:t}})}testCaseId(t){return this.#e({type:"metadata",data:{testCaseId:t}})}attachment(t,s,r){let n=s?.type==="Buffer"?s.data:s,a=typeof n=="string"?"utf8":"base64",o=ce(n);return this.#e({type:"attachment_content",data:{name:t,content:o,encoding:a,contentType:r.contentType,fileExtension:r.fileExtension}})}attachmentFromPath(t,s,r){return this.#e({type:"attachment_path",data:{name:t,path:s,contentType:r.contentType,fileExtension:r.fileExtension}})}logStep(t,s=u.PASSED,r){return cy.wrap(_,{log:!1}).then(()=>(this.#e({type:"step_start",data:{name:t,start:Date.now()}}),Cypress.Promise.resolve())).then(()=>this.#e({type:"step_stop",data:{status:s,stop:Date.now(),statusDetails:r?{...f(r)}:void 0}}))}step(t,s){return cy.wrap(_,{log:!1}).then(()=>(this.#e({type:"step_start",data:{name:t,start:Date.now()}}),Cypress.Promise.resolve(s()))).then(r=>this.#e({type:"step_stop",data:{status:u.PASSED,stop:Date.now()}}).then(()=>r))}stepDisplayName(t){return this.#e({type:"step_metadata",data:{name:t}})}stepParameter(t,s,r){return this.#e({type:"step_metadata",data:{parameters:[{name:t,value:s,mode:r}]}})}flushAllureMessagesToTask=t=>{let s=this.#s();s.length&&cy.task(t,{absolutePath:Cypress.spec.absolute,messages:s},{log:!1})};flushAllureMessagesToTaskAsync=t=>{let s=this.#s();if(s.length){let r={absolutePath:Cypress.spec.absolute,messages:s,isInteractive:Cypress.config("isInteractive")};return cy.task(t,r,{log:!1})}};#t=()=>oe([]);#e=t=>(c(t),Cypress.Promise.resolve());#s=()=>{let t=M();return this.#t(),t}},xe=()=>L(new W),Ee=()=>U(),_e=()=>{c({type:"cypress_run_start",data:{}})},Me=e=>{c({type:"cypress_suite_start",data:{id:e.id,name:e.title,root:e.root,start:Date.now()}})},be=e=>{c({type:"cypress_suite_end",data:{root:e.root,stop:Date.now()}})},$=(e,t)=>{c({type:"cypress_hook_start",data:{name:e.title,scopeType:e.hookName.includes("each")?"each":"all",position:e.hookName.includes("before")?"before":"after",start:t??Date.now()}})},w=e=>{c({type:"cypress_hook_end",data:{duration:e.duration??0}})},Y=e=>{ue(e),c({type:"cypress_test_start",data:V(e)}),z(e)},q=(e,t)=>{let s=M();F(s).forEach(()=>{c({type:"step_stop",data:{stop:Date.now(),status:e,statusDetails:t}})})},Ae=()=>{q(u.PASSED),c({type:"cypress_test_pass",data:{}})},Re=e=>{b(e)?De(u.SKIPPED,{message:"The test was skipped before the command was completed"}):Y(e),c({type:"cypress_test_skip",data:K()})},Pe=e=>{c({type:"cypress_command_start",data:{name:`Command "${e.attributes.name}"`,args:e.attributes.args.map(t=>typeof t=="string"?t:JSON.stringify(t,null,2)),start:Date.now()}})},ke=()=>{c({type:"cypress_command_end",data:{status:u.PASSED,stop:Date.now()}})},we=(e,t)=>{c({type:"attachment_path",data:{path:e,name:t||"Screenshot",contentType:D.PNG}})},De=(e,t)=>{let s=M(),r=s.toReversed().findIndex(({type:i})=>i==="cypress_command_start"),n=s.toReversed().findIndex(({type:i})=>i==="cypress_command_end"),a=r>n,o={status:e,stop:Date.now()};t&&(o.statusDetails=t),a&&c({type:"cypress_command_end",data:o})},Z=e=>{let t=S(e),s=f(e);De(t,s),c({type:"cypress_fail",data:{status:t,statusDetails:s}})},J=e=>{c({type:"cypress_test_end",data:{duration:e.duration??0,retries:e._retries??0}}),le()},X=(e,t)=>{let s=e.hookName.includes("each"),r=e.parent,n=Mt(e.title,s,t,r);w(e),xt(),Et(r,n)},Ie=()=>{let[e,t,s]=Pt();Rt(t,s),kt(e)},Q=()=>Ee().flushAllureMessagesToTask("reportAllureCypressSpecMessages"),He=()=>Ee().flushAllureMessagesToTaskAsync("reportFinalAllureCypressSpecMessages"),A=e=>{if(Ht(e)){let t=e.test;return C(t)||w(t),He()}},Fe=(e,t)=>{try{return Z(t),X(e.test,t),He()}catch(s){It(e,s)}},xt=()=>{let e=pe();e&&J(e)},Et=(e,t)=>{for(let s of Se(e))b(s)||_t(s,s.pending?{...K(),status:u.SKIPPED}:t)},_t=(e,t)=>{c({type:"cypress_skipped_test",data:{...V(e),...t,...ye(e),suites:de(e).map(s=>s.id)}}),z(e)},Mt=(e,t,s,r)=>{let n=t?u.SKIPPED:S(s),{message:a,trace:o}=f(s);return{status:n,statusDetails:{message:t?bt(e,r):a,trace:o}}},bt=(e,t)=>{let s=t.title?`'${t.title}'`:"root";return`'${e}' defined in the ${s} suite has failed`},At=(e,...t)=>{let[s,r,n]=t;return typeof n>"u"&&typeof r>"u"?e(s):typeof r=="function"?e(s,r):e(s,r,n)},Rt=(e,t)=>{let s=a=>(o,i,p)=>{e();try{return At(a,o,i,p)}finally{t()}},r=globalThis.describe,n=s(r);n.only=s(r.only),n.skip=s(r.skip),globalThis.describe=n},Pt=()=>{let e=0;return[()=>e,()=>{e++},()=>{e--}]},kt=e=>{let t=globalThis.after,s=(r,n)=>typeof r=="string"?t(r,Te(e,n)):t(Te(e,r));globalThis.after=s},Te=(e,t)=>{if(e()===0&&t){let s=t.length?wt(t):Dt(t);return Object.defineProperty(s,"name",{value:t.name}),s}return t},wt=e=>function(t){let s=r=>{if(r){Fe(this,r)?.then(()=>t(r))||t(r);return}try{if(A(this)?.then(()=>t()))return}catch(n){t(n);return}t()};return e.bind(this)(s)},Dt=e=>function(){let t,s;try{t=e.bind(this)()}catch(r){s=r}if(s)Ce(this,s);else return x(t)?t.then(()=>A(this),r=>Ce(this,r)):(A(this),t)},Ce=(e,t)=>{if(!Fe(e,t)?.then(()=>{throw t}))throw t},It=(e,t)=>{try{console.error(`Unexpected error when reporting the failure of ${e.test?.title??"'after all'"}`),console.error(t)}catch{}},Ht=e=>{let t=e.test;return e.test.parent.hooks.findLast(a=>a.hookName==="after all")?.hookId===t.hookId};var{EVENT_RUN_BEGIN:Ft,EVENT_SUITE_BEGIN:Ot,EVENT_SUITE_END:Nt,EVENT_HOOK_BEGIN:Lt,EVENT_HOOK_END:Ut,EVENT_TEST_BEGIN:jt,EVENT_TEST_PASS:Gt,EVENT_TEST_FAIL:Bt,EVENT_TEST_PENDING:Vt,EVENT_TEST_END:Kt}=Mocha.Runner.constants,zt=()=>{ne()||(ae(),Cypress.mocha.getRunner().on(Ft,()=>{xe(),_e()}).on(Ot,e=>{e.root&&ge(Cypress.spec,e),Me(e)}).on(Nt,e=>{be(e)}).on(Lt,e=>{C(e)||$(e)}).on(Ut,e=>{C(e)||w(e)}).on(jt,e=>{b(e)||Y(e)}).on(Gt,()=>{Ae()}).on(Bt,(e,t)=>{let s="hookName"in e;if(s&&ve(e))return;s&&C(e)&&$(e,Date.now()-(e.duration??0)),Z(t),s&&X(e,t)}).on(Vt,e=>{Re(e)}).on(Kt,e=>{J(e)}),Cypress.Screenshot.defaults({onAfterScreenshot:(e,{path:t,name:s})=>{we(t,s)}}),Cypress.on("fail",e=>{let t=S(e),s=f(e);throw q(t,s),e}),Cypress.on("command:start",e=>{B(e)||Pe(e)}),Cypress.on("command:end",e=>{B(e)||ke()}),afterEach(E,Q),after(E,function(){Q(),A(this)}),Ie())};zt();export{D as ContentType,l as LabelName,R as LinkType,Le as Severity,Ne as Stage,u as Status,Oe as StatusByPriority,at as allureId,Xe as attachment,Qe as attachmentPath,$e as description,Ye as descriptionHtml,qe as displayName,ot as epic,it as feature,Ze as historyId,rt as issue,y as label,Ke as labels,yt as layer,G as link,ze as links,tt as logStep,dt as owner,We as parameter,lt as parentSuite,mt as severity,st as step,pt as story,ct as subSuite,ut as suite,gt as tag,ft as tags,Je as testCaseId,nt as tms};
//# sourceMappingURL=index.js.map
